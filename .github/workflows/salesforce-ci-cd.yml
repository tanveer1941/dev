name: Salesforce CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  deploy-to-dev:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Salesforce CLI
      run: npm install -g @salesforce/cli

    - name: Authenticate to Dev Org
      run: |
        echo "${{ secrets.SALESFORCE_AUTH_URL }}" > auth.txt
        sf org login sfdx-url --sfdx-url-file auth.txt --alias ${{ secrets.SALESFORCE_ORG_ALIAS }}
        rm -f auth.txt

    - name: Deploy to Dev Org
      run: |
        echo "ðŸš€ Deploying to Dev Org..."
        sf project deploy start --target-org ${{ secrets.SALESFORCE_ORG_ALIAS }}
        echo "âœ… Dev org deployment completed!"

    - name: Run tests
      run: |
        echo "ðŸ§ª Running tests..."
        sf apex run test --target-org ${{ secrets.SALESFORCE_ORG_ALIAS }} --result-format human

    - name: Create deployment summary
      run: |
        echo "## ðŸŽ‰ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Summary" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Deployment successful" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Tests completed" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ•’ Completed at: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”– Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY